<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-messaging.js"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<html lang="en">
<style>
    h3{
        background-color: #007bff;
        color: white;
        padding: .5rem 1rem;
        font-size: 1.25rem;
        line-height: 1.5;
        border-radius: .3rem;
    }
    .invalid{
        color:red;
        display: none;
    }
    .trash{
        margin-left: 10px;
    }
    .add{
        margin-left:10px;
    }
    h5{
        margin-right: 10px;
    }
</style>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
      
    <button type = "button"><a style="color:black;text-decoration:none;" href="admin.html">admin page</a></button>
 
  </head>

  <body class="bg-light">
    <div class="container">
      
      <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
        </div>
        <div class="col-md-8 order-md-1">
          <h4 class="mb-3">College Reaction Solutions</h4>
          <form id = "main" class="needs-validation" novalidate>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="firstName">First name</label>
                <input type="text" class="form-control" id="firstName" placeholder="" value="" required>
                <div class="first invalid">
                  Valid first name is required.
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="lastName">Last name</label>
                <input type="text" class="form-control" id="lastName" placeholder="" value="" required>
                <div class="last invalid">
                  Valid last name is required.
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="compname">Company Name</label>
              <div class="input-group">
                <input type="text" class="form-control" id="compname" placeholder="Company Name" required>
                <div class="comp invalid" style="width: 100%;">
                  Your company name is required.
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" placeholder="you@example.com">
              <div class="email invalid">
                Please enter a valid email address
              </div>
            </div>

            <div class="mb-3">
                <label for="phone">Phone number</label>
                <input type = "phone" class = "form-control" id = "phone" placeholder="555-555-5555">
                <div class="phone invalid">
                    Please enter a valid phone number
                </div>
            </div>

            <div class="mb-3">
                <label for="message">Message</label>
                <textarea id = "message" class = "form-control" rows="4" cols ="50"></textarea>
            </div>
                <div class="mb-3">
                    <button id="addQ" type="button" class = "btn btn-primary query">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                    <button id="confirm" type="button" class = "btn btn-primary">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            <div class="row">
            <button type="button" onclick="save()" class="btn btn-primary btn-lg btn-block" type="submit">Submit Poll</button>
          </form>
        </div>
      </div>
    </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  </body>
</html>

<script>
  var addingQ=true;
  var numAs = 0;
  $(document).ready(function() {
      $("#confirm").hide();
      $(".response").hide();
      $(document).on("click", "button.trashA" , function() {
          //we are going to delete an answer
            var parentElem = $(this).parent();
            $(this).css("background-color","yellow");
            $(parentElem).css("background-color","yellow");
            var remaining = $(parentElem).nextAll( ".A" ).find("h5");
            for(var i = 0;i < remaining.length;i++){
                var old = remaining[i].textContent.split("Answer ")[1];
                remaining[i].textContent = "Answer " + (old - 1);
            }
            $(parentElem).remove();
      });
      $(document).on("click", "button.trash" , function() {
          //we are going to delete a question
          var parentElem = $(this).parent();
            $(parentElem).nextUntil( ".Q, button" ).remove();
            var remaining = $(parentElem).nextAll( ".Q" ).find("h3");
            for(var i = 0;i < remaining.length;i++){
                var old = remaining[i].textContent.split("Question ")[1];
                remaining[i].textContent = "Question " + (old - 1);
            }
            $(parentElem).remove();
      });
      $(document).on("click", "button.add" , function() {
          var parentElem = this.parentElement;
          var numAs = $(parentElem).children(".A").length + 1;
          console.log("numAs ",numAs);
          $(parentElem).append("<div class='A mb-3'><label style='margin-bottom:10px; for='answer'><h5>Answer " + numAs + "</h5></label><button type='button' class='trashA btn btn-danger'><span class='glyphicon glyphicon-trash'></span></button><textarea class = 'answer form-control' rows='4' cols ='50'></textarea></div>");
            console.log("done");
      });
  });
  $("#addQ").click(function() {
      $( "<div class='Q mb-3'><label for='question'><h3>Question " + ($( ".question" ).length + 1) + "</h3></label><button type='button' class='trash btn btn-danger'><span class='glyphicon glyphicon-trash'></span></button><button type='button' class='add btn btn-success'><span class='glyphicon glyphicon-plus'></span></button><textarea class = 'question form-control' rows='4' cols ='50'></textarea></div>").insertBefore("#addQ");
  });

$("#confirm").click(function() {
    addingQ = true;
    numAs = 0;
    $("#confirm").hide();
    $("#addQ").text("Add Question");
});
  function recordQuestions(){
    var key = localStorage.getItem("newRef");
    var newRef = firebase.database().ref('requests/'+key+'/questions');
        questions.forEach(function(name,index){
        console.log("questions[index]",questions[index]);
        console.log("answers[index]",answers[index]);
        newRef.push().set({
            question: questions[index],
            responses: answers[index]
        });
    });
  }
  function validateEmail(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }
  function validatePhone(phone){
    var re = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im;
    return re.test(String(phone).toLowerCase());
  }
  function insertData(){
        
        var bad = 0;
        var first = $("#firstName").val();
        if(!first){
            bad = 1;
            $(".first").css("display","inline");
        }else{
            $(".first").css("display","none");
        }
        var last = $("#lastName").val();
        if(!last){
            bad = 1;
            $(".last").css("display","inline");
        }
        else{
            $(".last").css("display","none");
        }
        var compname = $("#compname").val();
        if(!compname){
            bad = 1;
            $(".comp").css("display","inline");
        }
        else{
            $(".comp").css("display","none");
        }
        var email = $("#email").val();
        if(!email || !validateEmail(email)){
            bad = 1;
            $(".email").css("display","inline");
        }
        else{
            $(".email").css("display","none");
        }
        var phone = $("#phone").val();
        if(!phone || !validatePhone(phone)){
            bad = 1;
            $(".phone").css("display","inline");
        }
        else{
            $(".phone").css("display","none");
        }
        var message = $("#message").val();
        var questions =[];
        var answers = [];
        $( ".Q" ).each(function( index ) {
            answers.push([]);
            questions.push($( this ).find(".question").val());
            var AnswerElems = Array.from($(this).children( ".A" ));
            AnswerElems.forEach(function(element){
                answers[answers.length - 1].push(element.querySelector(".answer").value);
            });
            if(answers[answers.length - 1].length < 2){
                bad = 1;
                alert("Each question must have at least two possible responses");
            }
            
        });
        if(questions.length < 1){
            bad = 1;
            alert("There must be at least one question");
        }
        console.log("questions ",questions);
        console.log("answers ",answers);
        //bad = 1;
        if(!bad){
            const request = new XMLHttpRequest()
              request.addEventListener('load', () => {
                if (request.status === 200) {
                  console.log("Write succeeded!");
                  localStorage.setItem("newRef",JSON.parse(request.responseText));
                  window.location.href = "maps/copy.html";
                }
                if(request.status === 400){
                    var error = JSON.parse(request.responseText);
                    bad = 1;
                    $(".phone").css("display","none");
                    $(".email").css("display","none");
                    $("."+error).css("display","inline");
                }
              })

              request.open('POST', '/requests', true)
              request.setRequestHeader('Content-type', 'application/json')
              request.send(JSON.stringify({ 
                first: first,
                last: last,
                compname: compname,
                email: email,
                phone: phone,
                message: message,
                questions: JSON.stringify(questions),
                answers: JSON.stringify(answers)
              }));
            
        }
  }
  function save(){
     insertData();   
  }

</script>

